# ๐ ูุธุงู ุงูุตูุงุญูุงุช ูุงูุฃุฏูุงุฑ - Permissions & Roles System

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ุตูุงุญูุงุช ูุฃุฏูุงุฑ ูุชูุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช Prisma.

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ:** 18 ุฃูุชูุจุฑ 2025
**ุงูุญุงูุฉ:** โ ููุชูู ูุฌุงูุฒ

---

## ๐ฏ ุงูุฃุฏูุงุฑ ุงููุชุงุญุฉ

### 1. ๐ SUPER_ADMIN (ูุฏูุฑ ุฃุนูู)
- **ุงูุตูุงุญูุงุช:** ูุงููุฉ ุจุฏูู ูููุฏ
- **ุงูุงุณุชุฎุฏุงู:** ุตุงุญุจ ุงูุจูุช ุฃู ุงููุฏูุฑ ุงูุฑุฆูุณู
- **ุงูุนุฏุฏ ุงูููุตู ุจู:** 1-2 ููุท

### 2. ๐ก๏ธ ADMIN (ูุฏูุฑ)
- **ุงูุตูุงุญูุงุช:** ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏูููุ ุงูุฃูุณุงูุ ุงูุชูุงุฑูุฑ
- **ุงูุงุณุชุฎุฏุงู:** ุงููุฏูุฑูู ูุงููุดุฑููู
- **ุงููููุฏ:** ูุง ููููู ุชุบููุฑ ุฏูุฑ ูุฏูุฑ ุขุฎุฑ

### 3. ๐ค USER (ูุณุชุฎุฏู)
- **ุงูุตูุงุญูุงุช:** ุงุณุชุฎุฏุงู ุงูุฃูุณุงู ุงููุณููุญ ุจูุง
- **ุงูุงุณุชุฎุฏุงู:** ุงูููุธููู ูุงููุณุชุฎุฏููู ุงูุนุงุฏููู
- **ุงููููุฏ:** ูุง ููููู ุงููุตูู ูููุญุฉ ุงูุชุญูู

### 4. ๐ GUEST (ุฒุงุฆุฑ)
- **ุงูุตูุงุญูุงุช:** ูุญุฏูุฏุฉ ุฌุฏุงู (ุนุฑุถ ููุท)
- **ุงูุงุณุชุฎุฏุงู:** ุงูุฏูุฑ ุงูุงูุชุฑุงุถู ูุฃู ูุณุชุฎุฏู ุฌุฏูุฏ
- **ุงููููุฏ:** ูุง ููููู ุชูููุฐ ุฃู ุฅุฌุฑุงุกุงุช

---

## ๐ฆ ุงูููููุงุช ุงูููููุฐุฉ

### 1. Prisma Schema
```prisma
model User {
  id                Int       @id @default(autoincrement())
  telegramId        BigInt    @unique
  role              Role      @default(GUEST)
  isActive          Boolean   @default(true)
  isBanned          Boolean   @default(false)
  customPermissions String?   // JSON array
  // ... more fields
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  GUEST
}
```

### 2. Permission Service
```typescript
PermissionService.hasPermission(userContext, 'users.create')
PermissionService.hasRole(userContext, 'ADMIN')
PermissionService.hasMinRole(userContext, 'USER')
PermissionService.canAccessFeature(userContext, ['ADMIN'])
```

### 3. Role Manager
```typescript
RoleManager.changeRole({ userId, newRole, changedBy, reason })
RoleManager.banUser(userId, bannedBy, reason)
RoleManager.unbanUser(userId, unbannedBy)
RoleManager.getRoleStatistics()
RoleManager.getOrCreateUser(telegramId, userData)
```

### 4. Middleware
```typescript
import { requireMinRole, requirePermission, requireRole } from '#root/modules/permissions'

// ูู ูุนุงูุฌ ูุนูู
composer.use(requireRole('ADMIN'), async (ctx) => {
  // ููุท ููุฃุฏูู
})

composer.use(requireMinRole('USER'), async (ctx) => {
  // ูููุณุชุฎุฏู ููุง ููู
})

composer.use(requirePermission('users.create'), async (ctx) => {
  // ููุท ูู ูุฏูู ุตูุงุญูุฉ ุฅูุดุงุก ูุณุชุฎุฏููู
})
```

---

## ๐ ุงูุงุณุชุฎุฏุงู

### ุชุญููู ุงูุตูุงุญูุงุช ุชููุงุฆูุงู
ุงูุตูุงุญูุงุช ุชูุญูู ุชููุงุฆูุงู ูู `src/bot/index.ts`:

```typescript
// ููููุฐ ููู update
protectedBot.use(async (ctx, next) => {
  // ุฅูุดุงุก/ุฌูุจ ุงููุณุชุฎุฏู ูู DB
  await RoleManager.getOrCreateUser(BigInt(ctx.from.id), {...})
  await next()
})

// ุชุญููู ุงูุตูุงุญูุงุช ุฅูู ctx.dbUser
protectedBot.use(loadUserPermissions())
```

### ุงุณุชุฎุฏุงู ุงูุตูุงุญูุงุช ูู ุงูุฃูุณุงู
```typescript
// ูู config.ts
export const myFeatureConfig: FeatureConfig = {
  id: 'my-feature',
  name: 'ูุณูู',
  permissions: ['ADMIN', 'USER'], // โ ููุง

  subFeatures: [
    {
      id: 'sensitive-action',
      name: 'ุฅุฌุฑุงุก ุญุณุงุณ',
      permissions: ['SUPER_ADMIN'], // โ ููุท ููุณูุจุฑ ุฃุฏูู
    },
  ],
}
```

### ุงูุชุญูู ูุฏููุงู ูู ุงููุนุงูุฌ
```typescript
composer.callbackQuery('my-action', async (ctx) => {
  if (!ctx.dbUser) {
    await ctx.reply('โ ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู')
    return
  }

  if (ctx.dbUser.isBanned) {
    await ctx.reply('โ ุชู ุญุธุฑู')
    return
  }

  if (!PermissionService.hasMinRole(ctx.dbUser, 'ADMIN')) {
    await ctx.reply('โ ุตูุงุญูุฉ ุบูุฑ ูุงููุฉ')
  }

  // ุชูููุฐ ุงูุฅุฌุฑุงุก
})
```

---

## ๐ก๏ธ ููุญุฉ ุงูุชุญูู (Admin Panel)

### ุงููุตูู
```
ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ โ ๐ก๏ธ ููุญุฉ ุงูุชุญูู
```

### ุงูุฃูุณุงู ุงููุฑุนูุฉ
1. **๐ฅ ูุงุฆูุฉ ุงููุณุชุฎุฏููู** - ุนุฑุถ ูุฅุฏุงุฑุฉ ุฌููุน ุงููุณุชุฎุฏููู โ
2. **๐ ุชุบููุฑ ุงูุฃุฏูุงุฑ** - ุชุบููุฑ ุฏูุฑ ุงููุณุชุฎุฏููู โ
3. **๐ซ ุญุธุฑ ูุณุชุฎุฏู** - ุญุธุฑ/ุฅูุบุงุก ุญุธุฑ โ
4. **๐ ุงูุฅุญุตุงุฆูุงุช** - ุฅุญุตุงุฆูุงุช ุดุงููุฉ โ

**ุฌููุน ุงููุนุงูุฌุงุช ููููุฐุฉ ูุฌุงูุฒุฉ! ๐**

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชุงุญุฉ

```typescript
const stats = await RoleManager.getRoleStatistics()

// ุงููุชูุฌุฉ:
{
  superAdmins: 1,
  admins: 3,
  users: 45,
  guests: 12,
  total: 61,
  active: 58,
  banned: 2,
  inactive: 3
}
```

---

## ๐ ุงูุฃูุงู

### 1. ุงูููุงุนุฏ ุงูุงูุชุฑุงุถูุฉ
- โ ุฃู ูุณุชุฎุฏู ุฌุฏูุฏ ููุณุฌู ูู `GUEST`
- โ ุงููุญุธูุฑูู ูุง ูููููู ุงููุตูู ูุฃู ุดูุก
- โ ุบูุฑ ุงููุดุทูู ูุง ูููููู ุงููุตูู

### 2. ุชุบููุฑ ุงูุฃุฏูุงุฑ
- โ ููุท ุฏูุฑ ุฃุนูู ููููู ุชุบููุฑ ุฏูุฑ ุฃูู
- โ ูุง ูููู ุชุนููู ุฏูุฑ ุฃุนูู ูู ุฏูุฑู
- โ ููุณุฌู ูู ุชุบููุฑ ูู `RoleChange` model

### 3. ุงูุตูุงุญูุงุช ุงููุฎุตุตุฉ
```typescript
// ุฅุถุงูุฉ ุตูุงุญูุฉ ูุฎุตุตุฉ
await PermissionService.addCustomPermission(userId, 'reports.delete')

// ุฅุฒุงูุฉ ุตูุงุญูุฉ
await PermissionService.removeCustomPermission(userId, 'reports.delete')
```

---

## ๐ ููุงุฐุฌ ุงูุจูุงูุงุช

### User Model
```typescript
{
  id: number
  telegramId: bigint
  username: string | null
  firstName: string | null
  lastName: string | null
  role: Role
  isActive: boolean
  isBanned: boolean
  bannedAt: Date | null
  bannedReason: string | null
  customPermissions: string | null // JSON
  department: string | null
  position: string | null
}
```

### RoleChange Model
```typescript
{
  id: number
  userId: number
  oldRole: Role
  newRole: Role
  changedBy: number
  reason: string | null
  createdAt: Date
}
```

---

## โ ุงูุฎูุงุตุฉ

**ุชู ุฅูุฌุงุฒู:**
- โ Prisma Schema ูุน 4 ุฃุฏูุงุฑ
- โ Permission Service ูุงูู
- โ Role Manager ูุฅุฏุงุฑุฉ ุงูุฃุฏูุงุฑ
- โ Middleware ููุชุญูู (8 functions)
- โ ุชูุงูู ูุน Features System
- โ Admin Panel ูุงูู (4 ูุนุงูุฌุงุช)
- โ ุชุญููู ุชููุงุฆู ูููุณุชุฎุฏููู

**ุฌุงูุฒ ููุงุณุชุฎุฏุงู:** ๐

---

## ๐ฏ Admin Panel - ุงูุชูุงุตูู ุงููุงููุฉ

### 1๏ธโฃ ูุงุฆูุฉ ุงููุณุชุฎุฏููู (`users-list.ts`)

**ุงููููุฒุงุช:**
- โ ุนุฑุถ ูููุณู ูุตูุญุงุช (5 ูุณุชุฎุฏููู/ุตูุญุฉ)
- โ ููุชุฑุฉ ุญุณุจ ุงูุฏูุฑ (ูุฏูุฑููุ ูุณุชุฎุฏููู)
- โ ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ (ูุดุทููุ ูุญุธูุฑูู)
- โ ุนุฑุถ ุชูุงุตูู ูุงูู ููู ูุณุชุฎุฏู
- โ ุชุงุฑูุฎ ุชุบููุฑ ุงูุฃุฏูุงุฑ (ุขุฎุฑ 3 ุชุบููุฑุงุช)
- โ ุฃุฒุฑุงุฑ ุณุฑูุนุฉ ููุฅุฌุฑุงุกุงุช (ุชุบููุฑ ุฏูุฑุ ุญุธุฑ)

**ุงูุชุฏูู:**
```
ูุงุฆูุฉ ุงููุณุชุฎุฏููู โ ุงุฎุชุฑ ูุณุชุฎุฏู โ ุนุฑุถ ุงูุชูุงุตูู โ [ุชุบููุฑ ุงูุฏูุฑ | ุญุธุฑ]
```

---

### 2๏ธโฃ ุชุบููุฑ ุงูุฃุฏูุงุฑ (`change-role.ts`)

**ุงููููุฒุงุช:**
- โ ุงุฎุชูุงุฑ ูุณุชุฎุฏู ูู ูุงุฆูุฉ
- โ ุนุฑุถ ุงูุฏูุฑ ุงูุญุงูู
- โ ุงุฎุชูุงุฑ ุงูุฏูุฑ ุงูุฌุฏูุฏ (ูุน ูุญุต ุงูุตูุงุญูุงุช)
- โ ุฅุฏุฎุงู ุณุจุจ ุงูุชุบููุฑ (ุงุฎุชูุงุฑู)
- โ ุชุฃููุฏ ูุจู ุงูุชูููุฐ
- โ ุชุณุฌูู ุชููุงุฆู ูู `RoleChange` table

**ุงูุญูุงูุฉ:**
- ๐ ููุท ุฏูุฑ ุฃุนูู ููููู ุชุบููุฑ ุฏูุฑ ุฃูู
- ๐ ูุง ูููู ุชุนููู ุฏูุฑ ุฃุนูู ูู ุฏูุฑู
- ๐ ุงูุฃุฏูุงุฑ ุบูุฑ ุงููุณููุญุฉ ุชุธูุฑ ูุน ๐

**ุงูุชุฏูู:**
```
ุชุบููุฑ ุงูุฃุฏูุงุฑ โ ุงุฎุชุฑ ูุณุชุฎุฏู โ ุงุฎุชุฑ ุฏูุฑ ุฌุฏูุฏ โ [ุฃุฏุฎู ุณุจุจ] โ ุชุฃููุฏ โ โ
```

---

### 3๏ธโฃ ุญุธุฑ ุงููุณุชุฎุฏููู (`ban-user.ts`)

**ุงููููุฒุงุช:**
- โ ุญุธุฑ ูุณุชุฎุฏู ุฌุฏูุฏ
- โ ุฅูุบุงุก ุญุธุฑ ูุณุชุฎุฏู ูุญุธูุฑ
- โ ุนุฑุถ ูุงุฆูุฉ ุงููุญุธูุฑูู
- โ 4 ุฃุณุจุงุจ ุฌุงูุฒุฉ + ุณุจุจ ูุฎุตุต
- โ ุญูุธ ุณุจุจ ุงูุญุธุฑ ูุชุงุฑูุฎู

**ุงูุฃุณุจุงุจ ุงูุฌุงูุฒุฉ:**
1. ุงูุชูุงู ุดุฑูุท ุงูุงุณุชุฎุฏุงู
2. ุณููู ุบูุฑ ูุงุฆู
3. ุงุณุชุฎุฏุงู ุฎุงุทุฆ ููุจูุช
4. ุฅุฑุณุงู ุฑุณุงุฆู ูุฒุนุฌุฉ

**ุงูุชุฏูู:**
```
ุญุธุฑ ูุณุชุฎุฏู โ ุงุฎุชุฑ [ุญุธุฑ | ุฅูุบุงุก ุญุธุฑ | ูุงุฆูุฉ ุงููุญุธูุฑูู]
โ ุงุฎุชุฑ ูุณุชุฎุฏู โ [ุงุฎุชุฑ ุณุจุจ] โ ุชุฃููุฏ โ โ
```

---

### 4๏ธโฃ ุงูุฅุญุตุงุฆูุงุช (`index.ts`)

**ุงููููุฒุงุช:**
- โ ุฅุฌูุงูู ุงููุณุชุฎุฏููู
- โ ุงููุดุทูู / ุบูุฑ ุงููุดุทูู
- โ ุงููุญุธูุฑูู
- โ ุชูุฒูุน ุงูุฃุฏูุงุฑ (ูุฏูุฑููุ ูุณุชุฎุฏูููุ ุฒูุงุฑ)
- โ ุฒุฑ ุชุญุฏูุซ

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

**ุงูููุฏ ุงูููุถุงู:**
- 3 ูููุงุช handlers ุฌุฏูุฏุฉ
- ~800 ุณุทุฑ ููุฏ
- 15+ ูุนุงูุฌ callback
- 10+ helper functions

**ุงูููุช ุงูููุณุชุบุฑู:** ~3 ุณุงุนุงุช

---

**ุงููุฑุฌุน ุงููุงูู:** `src/modules/permissions/`
**Admin Panel:** `src/bot/features/admin-panel/`
**ุงููุนุงูุฌุงุช:** `src/bot/features/admin-panel/handlers/`
