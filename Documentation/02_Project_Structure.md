
# بنية المشروع

تم تصميم قالب **bot-base/telegram-bot-template** بهيكل واضح ومنظم لتسهيل عملية التطوير والصيانة. فيما يلي شرح مفصل للمجلدات والملفات الأساسية في المشروع وكيفية تفاعلها معًا.

## الهيكل العام للمشروع

```
project-root/
  ├── locales # ملفات الترجمة
  └── src
      ├── bot # الكود المتعلق بالروبوت
      │   ├── callback-data # بيانات الاستدعاء (Callback Data)
      │   ├── features      # ميزات الروبوت
      │   ├── filters       # فلاتر التحديثات
      │   ├── handlers      # معالجات التحديثات
      │   ├── helpers       # دوال مساعدة
      │   ├── keyboards     # لوحات المفاتيح (Keyboards)
      │   ├── middlewares   # برمجيات وسيطة (Middlewares)
      │   ├── i18n.ts       # إعدادات الترجمة
      │   ├── context.ts    # تعريف كائن السياق (Context)
      │   └── index.ts      # نقطة الدخول للروبوت
      ├── server # الكود المتعلق بخادم الويب
      │   ├── middlewares   # برمجيات وسيطة للخادم
      │   ├── environment   # إعدادات بيئة الخادم
      │   └── index.ts      # نقطة الدخول للخادم
      ├── config.ts # إعدادات التطبيق
      ├── logger.ts # إعدادات تسجيل الأنشطة
      └── main.ts   # نقطة الدخول الرئيسية للتطبيق
```

## شرح المجلدات والملفات

### `locales`

-   **الوصف:** يحتوي هذا المجلد على ملفات الترجمة الخاصة بالروبوت. كل ملف `*.ftl` يمثل لغة معينة (مثل `en.ftl` للغة الإنجليزية). يستخدم القالب نظام Fluent لتوفير نصوص ديناميكية ومتعددة اللغات.
-   **التفاعل:** يتم استخدام هذه الملفات بواسطة `src/bot/i18n.ts` لتهيئة ودعم تعدد اللغات في الروبوت.

### `src`

هذا هو المجلد الرئيسي الذي يحتوي على كل الكود المصدري للتطبيق.

#### `src/bot`

-   **الوصف:** يحتوي هذا المجلد على كل ما يتعلق بمنطق عمل روبوت تليجرام.
    -   `callback-data`: يحتوي على مُنشِئات بيانات الاستدعاء (callback data builders) التي تساعد في إنشاء وإدارة البيانات المرسلة من لوحات المفاتيح المضمنة (inline keyboards).
    -   `features`: هذا هو المكان الذي يتم فيه تعريف الميزات الأساسية للروبوت. كل ملف يمثل ميزة معينة (مثل `welcome.ts` لرسالة الترحيب). هذا التصميم المعياري يجعل من السهل إضافة أو إزالة الميزات.
    -   `filters`: يحتوي على دوال تصفية (filters) مخصصة يمكن استخدامها لتحديد ما إذا كان يجب معالجة تحديث معين أم لا (مثل `is-admin.ts` للتحقق مما إذا كان المستخدم هو المسؤول).
    -   `handlers`: يحتوي على معالجات (handlers) للأحداث المختلفة، مثل الأخطاء (`error.ts`) أو الأوامر المعقدة.
    -   `helpers`: يحتوي على دوال مساعدة (helper functions) يمكن إعادة استخدامها في أجزاء مختلفة من الروبوت (مثل `keyboard.ts` لتقسيم أزرار لوحة المفاتيح).
    -   `keyboards`: يحتوي على مُنشِئات لوحات المفاتيح (keyboard builders) التي تنشئ لوحات مفاتيح مخصصة (مضمنة أو عادية) لإرسالها للمستخدمين.
    -   `middlewares`: يحتوي على برمجيات وسيطة (middlewares) مخصصة للروبوت، مثل `session.ts` لإدارة جلسات المستخدم و`update-logger.ts` لتسجيل التحديثات الواردة.
    -   `i18n.ts`: يقوم بتهيئة وإعداد مكتبة الترجمة (`@grammyjs/i18n`).
    -   `context.ts`: يقوم بتعريف وتوسيع كائن السياق (`Context`) الخاص بـ `grammy` ليحتوي على خصائص إضافية مثل المسجل (`logger`) والإعدادات (`config`).
    -   `index.ts`: هذه هي نقطة الدخول الرئيسية للروبوت. يقوم بتجميع كل الميزات والبرمجيات الوسيطة معًا وإنشاء كائن الروبوت (`Bot`).

#### `src/server`

-   **الوصف:** يحتوي هذا المجلد على الكود المتعلق بخادم الويب (الذي يستخدم في وضع `webhook`).
    -   `middlewares`: يحتوي على برمجيات وسيطة خاصة بالخادم، مثل `request-id.ts` لإنشاء معرف فريد لكل طلب.
    -   `index.ts`: يقوم بإنشاء وتهيئة خادم الويب باستخدام `hono` وتوصيله بالروبوت.

#### `src/config.ts`

-   **الوصف:** مسؤول عن تحميل والتحقق من صحة متغيرات البيئة من ملف `.env`. يستخدم مكتبة `valibot` لضمان أن تكون جميع الإعدادات المطلوبة موجودة وصحيحة.
-   **التفاعل:** يتم استيراد الإعدادات (`config`) من هذا الملف في جميع أنحاء التطبيق للوصول إلى قيم مثل `BOT_TOKEN` و`LOG_LEVEL`.

#### `src/logger.ts`

-   **الوصف:** يقوم بتهيئة المسجل (`logger`) باستخدام مكتبة `pino`. يتم تكوينه ليعرض سجلات جميلة (pretty-print) في وضع التطوير (debug) ويكتب في ملف في وضع الإنتاج.
-   **التفاعل:** يتم توفير المسجل لجميع أجزاء التطبيق التي تحتاج إلى تسجيل معلومات أو أخطاء.

#### `src/main.ts`

-   **الوصف:** هذه هي نقطة الدخول الرئيسية للتطبيق بأكمله. بناءً على الإعدادات (`config`)، يقرر هذا الملف ما إذا كان يجب تشغيل الروبوت في وضع `polling` أو `webhook`.
-   **التEFAعل:** يقوم باستيراد الروبوت من `src/bot` والخادم من `src/server` ويقوم بتشغيل الوضع المناسب.

## كيفية تفاعل المكونات

1.  **بدء التشغيل:** عند تشغيل `npm run dev` أو `npm start`، يتم تنفيذ `src/main.ts`.
2.  **تحميل الإعدادات:** يقوم `src/main.ts` أولاً بتحميل الإعدادات من `src/config.ts`، الذي يقرأ ملف `.env`.
3.  **تهيئة المسجل:** يتم تهيئة المسجل في `src/logger.ts` بناءً على مستوى السجل المحدد في الإعدادات.
4.  **إنشاء الروبوت:** يقوم `src/main.ts` باستدعاء `createBot` من `src/bot/index.ts`.
5.  **تجميع الميزات:** داخل `createBot`، يتم تجميع جميع الميزات (`features`) والبرمجيات الوسيطة (`middlewares`) معًا.
6.  **تشغيل الروبوت:** أخيرًا، يقوم `src/main.ts` بتشغيل الروبوت إما عن طريق `polling` (الاتصال المستمر بخوادم تليجرام) أو `webhook` (إعداد خادم ويب لاستقبال التحديثات).

هذا الهيكل المنظم يضمن أن كل جزء من التطبيق له مسؤولية واضحة ومحددة، مما يجعل الكود سهل الفهم والتطوير والتوسع في المستقبل.
